name: deploy
description: "Deploy the app to production"
inputs:
  repo_token:
    description: "Github Token"
    required: true
  deploy_flag:
    description: "Flag to pass to ./run cdk deploy"
    required: false
    default: ""
  user_docs:
    description: "Create user docs"
    required: false
    default: "true"
  test:
    description: "Test deployed stack"
    required: false
    default: "true"
  env_name:
    description: "The name of the deploy environment"
    required: false
    default: ""
  env_url:
    description: "The URL of the deploy environment"
    required: false
    default: ""
runs:
  using: "composite"
  steps:
    - name: Create Review Environment
      if: ${{ inputs.env_url != '' }}
      uses: bobheadxi/deployments@v1.1.0
      id: deployment
      with:
        step: start
        token: ${{ inputs.repo_token }}
        env: ${{ inputs.env_name }}
        ref: ${{ github.head_ref }}
        desc: ${{ inputs.env_name }} environment

    - uses: unitasglobal/nio-shared-actions/python-setup@main
      with:
        install_node: true

    - name: Ensure Only One Deploy Run
      uses: softprops/turnstyle@v1
      env:
        GITHUB_TOKEN: ${{ inputs.repo_token }}

    - name: Build user docs for deploy
      if: ${{ inputs.user_docs == 'true' }}
      shell: bash
      run: ./run docs build-user-docs

    - name: Deploy
      shell: bash
      run: ./run cdk deploy ${{ inputs.deploy_flag }}

    - name: Test Deployed Stack
      if: ${{ inputs.test == 'true' }}
      shell: bash
      run: ./run test deployed

    - name: Update Environment Status
      uses: bobheadxi/deployments@v1.1.0
      if: ${{ inputs.env_url != '' && always() }}
      with:
        step: finish
        token: ${{ inputs.repo_token }}
        status: ${{ job.status }}
        env: ${{ steps.deployment.outputs.env }}
        deployment_id: ${{ steps.deployment.outputs.deployment_id }}
        env_url: ${{ inputs.env_url }}
