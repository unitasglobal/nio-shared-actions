name: deploy
description: 'Deploy the app to production'
inputs:
    user_docs:
      description: "create user docs"
      required: false
      default: "true"
    repo_token:
      description: "Github Token"
      required: true
    deploy_flag:
      description: "Flag to pass to ./run cdk deploy"
      default: ""
      required: false
    test:
      description: "Test deployed stack"
      default: "true"
      required: false
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v2

    - uses: unitasglobal/nio-shared-actions/python-setup@main
      with:
        install_node: true

    - name: Ensure Only One Deploy Run
      uses: softprops/turnstyle@v1
      env:
        GITHUB_TOKEN: ${{ inputs.repo_token }}

    - name: Build docker-compose env
      shell: bash
      run: ./run docker build

    - name: Build user docs for deploy
      if: ${{ inputs.user_docs }} == "true"
      shell: bash
      run: |
        ./run docs build-user-docs

    - name: Deploy
      shell: bash
      run: ./run cdk deploy ${{ inputs.deploy_flag }}

    - name: Test Deployed Stack
      if: ${{ inputs.test }} == "true"
      shell: bash
      run: ./run test deployed
